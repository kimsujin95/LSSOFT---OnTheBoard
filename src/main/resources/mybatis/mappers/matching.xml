<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="matching">

	<resultMap id="resultMapMatchingVo" type="MatchingVo">
		<result column="matching_no" property="matchingNo" />
		<result column="user_no" property="userNo" />
		<result column="matching_title" property="matchingTitle" />
		<result column="matching_content" property="matchingContent" />
		<result column="matching_people" property="matchingPeople" />
		<result column="matching_hits" property="matchingHits" />
		<result column="matching_status" property="matchingStatus" />
		<result column="matching_reg_date" property="matchingRegDate" />
		<result column="matching_member" property="matchingMember" />
	</resultMap>
	
	<resultMap id="resultMapMatchingGroupVo" type="MatchingGroupVo">
		<result column="matching_no" property="matchingNo" />
		<result column="user_no" property="userNo" />
		<result column="matching_people" property="matchingPeople" />
	</resultMap>
	
	<resultMap id="resultMapUserVo" type="UserVo">
		<result column="user_no" property="userNo" />
		<result column="user_age" property="userAge" />
		<result column="user_nickname" property="userNickname" />
		<result column="user_gender" property="userGender" />
	</resultMap>

	<!-- 매칭 리스트 -->
	<select id="list" resultMap="resultMapMatchingVo">
		<![CDATA[
			SELECT
				matching_no,
				user_no,
				matching_title,
				matching_content,
				matching_people,
				matching_status,
				matching_hits,
				matching_reg_date
			FROM
				matching
			ORDER BY
				matching_no DESC
		]]>
	</select>

	<!-- 매칭 글 등록 - 유저 나이 -->
	<!-- <select id="userAge" parameterType="int" resultType="int">
		<![CDATA[
			SELECT
			    to_char(sysdate, 'yyyy') - to_char(user_birth_date, 'yyyy') + 1
			FROM
			    users
			WHERE
			    user_no = #{userNo}
		]]>
	</select> -->

	<!-- 매칭 글 등록 - 게임 이름 -->
	<select id="gameName" resultType="GameVo">
		<![CDATA[
			SELECT
			    game_name_ko gameNameKo
			FROM
			    game
		]]>
	</select>

	<!-- 매칭 글 등록 - 게임 테마 -->
	<select id="gameTheme" resultType="ThemeVo">
		<![CDATA[
			SELECT
				theme_name themeName
			FROM
				theme
		]]>
	</select>

	<!-- 매칭 글 등록 -->
	<insert id="write" parameterType="MatchingVo">
		<selectKey keyProperty="matchingNo" resultType="int" order="BEFORE">
			<![CDATA[
				SELECT
					seq_matching_no.NEXTVAL
				FROM
					dual
			]]>
		</selectKey>
		<![CDATA[
			INSERT INTO
				matching(matching_no, user_no, matching_title, matching_content, matching_people, matching_status, matching_hits, matching_reg_date)
			VALUES
				(
					#{ matchingNo },
					#{ userNo },
					#{ matchingTitle},
					#{ matchingContent },
					#{ matchingPeople },
					'매칭중',
					0,
					sysdate
				)
		]]>
	</insert>

	<!-- 매칭글 등록 → 매칭 그룹 생성 -->
	<select id="createMatchingGroup" parameterType="matchingGroupVo">
		<![CDATA[
			INSERT INTO
				matching_group
			VALUES
				(
					#{ matchingNo },
					#{ userNo },
					#{ matchingPeople }
				)
		]]>
	</select>

	<!-- 매칭 글 읽기 -->
	<select id="read" parameterType="int" resultMap="resultMapMatchingVo">
		<![CDATA[
			SELECT
				matching_no,
				user_no,
				matching_title,
				matching_content,
				matching_people,
				matching_hits,
				matching_status,
				to_char(matching_reg_date, 'yyyy. mm. dd. hh24:mi') matching_reg_date
			FROM
				matching
			WHERE
				matching_no = #{ matchingNo }
		]]>
	</select>
	
	
	<!-- 매칭 글 읽기 - 조회수 증가 -->
	<update id="hitsUp">
		<![CDATA[
			UPDATE
				matching
			SET
				matching_hits = matching_hits + 1
			WHERE
				matching_no = #{ matchingNo }
		]]>
	</update>

	<!-- 매칭 글 읽기 - 매칭 참가 신청 -->
	<insert id="joinMatching" parameterType="matchingGroupVo">
		<![CDATA[
			INSERT INTO
				matching_group(matching_no, user_no)
			VALUES
				(
					#{ matchingNo },
					#{ userNo }
				)
		]]>	
	</insert>
	
	<!-- 리스트 / 매칭 글 읽기 - 현재 매칭 참가중인 인원 수 -->
	<select id="matchingMember" parameterType="int" resultType="int">
		<![CDATA[
			SELECT
			    COUNT(user_no) matching_member
			FROM
			    matching_group
			WHERE
			    matching_no = #{ matchingNo }
		]]>
	</select>
	
	<!-- 매칭 글 읽기 - 현재 매칭 참가중인 인원 정보 -->
	<select id="matchingMemberInfoList" parameterType="int" resultMap="resultMapUserVo">
		<![CDATA[
			SELECT
			    u.user_no,
			    u.user_nickname,
			    to_char(sysdate, 'yyyy') - to_char(u.user_birth_date, 'yyyy') + 1 user_age,
			    u.user_gender
			FROM
			    users u
			    RIGHT OUTER JOIN (
			        SELECT
			            user_no
			        FROM
			            matching_group
			        WHERE
			            matching_no = #{ matchingNo }
			    ) m ON u.user_no = m.user_no
		]]>
	</select>

</mapper>